/**
 * @description Parts__c ê°ì²´ì˜ ì¬ê³  ì•Œë¦¼ ì²˜ë¦¬ í•¸ë“¤ëŸ¬
 * @author Claude Code
 * @date 2025-07-29
 */
public with sharing class PartsInventoryHandler {
    
    /**
     * @description ë¶€í’ˆ ì¬ê³ ê°€ 10% ë¯¸ë§Œìœ¼ë¡œ ë–¨ì–´ì¡Œì„ ë•Œ ì•Œë¦¼ ë°œì†¡
     * @param newParts ì—…ë°ì´íŠ¸ëœ ë¶€í’ˆ ë ˆì½”ë“œ ë¦¬ìŠ¤íŠ¸
     * @param oldPartsMap ì´ì „ ë¶€í’ˆ ë ˆì½”ë“œ ë§µ
     */
    public static void checkLowStock(List<Parts__c> newParts, Map<Id, Parts__c> oldPartsMap) {
        System.debug('ğŸ”” [PartsInventoryHandler] ì¬ê³  í™•ì¸ ì‹œì‘');
        
        List<Parts__c> lowStockParts = new List<Parts__c>();
        
        for (Parts__c newPart : newParts) {
            Parts__c oldPart = oldPartsMap.get(newPart.Id);
            
            // ì¬ê³ ê°€ ë³€ê²½ë˜ì—ˆê³ , ê¸°ì¤€ ì¬ê³ ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ” ê²½ìš°ë§Œ ì²´í¬
            if (newPart.Quantity__c != oldPart.Quantity__c && 
                newPart.StandardInventory__c != null && 
                newPart.StandardInventory__c > 0) {
                
                // í˜„ì¬ ì¬ê³ ê°€ ê¸°ì¤€ ì¬ê³ ì˜ 10% ë¯¸ë§Œì¸ì§€ í™•ì¸
                Decimal lowStockThreshold = newPart.StandardInventory__c * 0.1;
                
                if (newPart.Quantity__c < lowStockThreshold) {
                    System.debug('âš ï¸ [PartsInventoryHandler] ì¬ê³  ë¶€ì¡± ê°ì§€: ' + newPart.Name);
                    System.debug('ğŸ“Š í˜„ì¬ ì¬ê³ : ' + newPart.Quantity__c + ', ê¸°ì¤€ ì¬ê³ : ' + newPart.StandardInventory__c);
                    lowStockParts.add(newPart);
                }
            }
        }
        
        if (!lowStockParts.isEmpty()) {
            sendLowStockNotifications(lowStockParts);
        }
    }
    
    /**
     * @description ì¬ê³  ë¶€ì¡± ì•Œë¦¼ ë°œì†¡
     * @param lowStockParts ì¬ê³ ê°€ ë¶€ì¡±í•œ ë¶€í’ˆ ë¦¬ìŠ¤íŠ¸
     */
    private static void sendLowStockNotifications(List<Parts__c> lowStockParts) {
        System.debug('ğŸ“§ [PartsInventoryHandler] ì•Œë¦¼ ë°œì†¡ ì‹œì‘, ëŒ€ìƒ ë¶€í’ˆ ìˆ˜: ' + lowStockParts.size());
        
        try {
            // Custom Notification Type ID ì¡°íšŒ (Setupì—ì„œ ë¯¸ë¦¬ ìƒì„± í•„ìš”)
            List<CustomNotificationType> notificationTypes = [
                SELECT Id, DeveloperName 
                FROM CustomNotificationType 
                WHERE DeveloperName = 'Parts_Low_Stock_Alert' 
                LIMIT 1
            ];
            
            if (notificationTypes.isEmpty()) {
                System.debug('âŒ [PartsInventoryHandler] Custom Notification Typeì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                // Fallback: ì´ë©”ì¼ ì•Œë¦¼ìœ¼ë¡œ ëŒ€ì²´
                sendEmailNotifications(lowStockParts);
                return;
            }
            
            Id notificationTypeId = notificationTypes[0].Id;
            List<Messaging.CustomNotification> notifications = new List<Messaging.CustomNotification>();
            
            for (Parts__c part : lowStockParts) {
                // ë¶€í’ˆ ì†Œìœ ìì—ê²Œ ì•Œë¦¼ ë°œì†¡
                Messaging.CustomNotification notification = new Messaging.CustomNotification();
                
                String title = 'ë¶€í’ˆ ì¬ê³  ë¶€ì¡± ì•Œë¦¼';
                String body = String.format(
                    '{0} ë¶€í’ˆì˜ ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ : {1}ê°œ (ê¸°ì¤€: {2}ê°œ)', 
                    new List<String>{
                        part.Name, 
                        String.valueOf(part.Quantity__c.intValue()), 
                        String.valueOf(part.StandardInventory__c.intValue())
                    }
                );
                
                notification.setTitle(title);
                notification.setBody(body);
                notification.setNotificationTypeId(notificationTypeId);
                notification.setTargetId(part.Id);
                
                try {
                    // aliasê°€ 'user17536916065362824897'ì¸ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ë°œì†¡
                    List<User> targetUsers = [SELECT Id FROM User WHERE Alias = 'user17536916065362824897' AND IsActive = true LIMIT 1];
                    
                    if (!targetUsers.isEmpty()) {
                        notification.send(new Set<String>{targetUsers[0].Id});
                        System.debug('âœ… [PartsInventoryHandler] ì•Œë¦¼ ë°œì†¡ ì„±ê³µ (user17536916065362824897 ì‚¬ìš©ì): ' + part.Name);
                    } else {
                        System.debug('âš ï¸ [PartsInventoryHandler] user17536916065362824897 ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ Ownerì—ê²Œ ë°œì†¡: ' + part.Name);
                        notification.send(new Set<String>{part.OwnerId});
                    }
                } catch (Exception e) {
                    System.debug('âŒ [PartsInventoryHandler] ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ' + part.Name + ', ì˜¤ë¥˜: ' + e.getMessage());
                }
            }
            
        } catch (Exception e) {
            System.debug('âŒ [PartsInventoryHandler] ì•Œë¦¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
            // Fallback: ì´ë©”ì¼ ì•Œë¦¼ìœ¼ë¡œ ëŒ€ì²´
            sendEmailNotifications(lowStockParts);
        }
    }
    
    /**
     * @description ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ (Custom Notification ì‹¤íŒ¨ ì‹œ ëŒ€ì²´)
     * @param lowStockParts ì¬ê³ ê°€ ë¶€ì¡±í•œ ë¶€í’ˆ ë¦¬ìŠ¤íŠ¸
     */
    private static void sendEmailNotifications(List<Parts__c> lowStockParts) {
        System.debug('ğŸ“§ [PartsInventoryHandler] ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ì‹œì‘');
        
        List<Messaging.SingleEmailMessage> emails = new List<Messaging.SingleEmailMessage>();
        
        for (Parts__c part : lowStockParts) {
            Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
            
            String subject = '[ê¸´ê¸‰] ë¶€í’ˆ ì¬ê³  ë¶€ì¡± ì•Œë¦¼ - ' + part.Name;
            String htmlBody = String.format(
                '<h2>ë¶€í’ˆ ì¬ê³  ë¶€ì¡± ì•Œë¦¼</h2>' +
                '<p><strong>ë¶€í’ˆëª…:</strong> {0}</p>' +
                '<p><strong>í˜„ì¬ ì¬ê³ :</strong> {1}ê°œ</p>' +
                '<p><strong>ê¸°ì¤€ ì¬ê³ :</strong> {2}ê°œ</p>' +
                '<p><strong>ì¬ê³ ìœ¨:</strong> {3}%</p>' +
                '<p>ë¶€í’ˆ ë³´ì¶©ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>',
                new List<String>{
                    part.Name,
                    String.valueOf(part.Quantity__c.intValue()),
                    String.valueOf(part.StandardInventory__c.intValue()),
                    String.valueOf(((part.Quantity__c / part.StandardInventory__c) * 100).setScale(1))
                }
            );
            
            email.setSubject(subject);
            email.setHtmlBody(htmlBody);
            
            // aliasê°€ 'user17536916065362824897'ì¸ ì‚¬ìš©ìì—ê²Œ ì´ë©”ì¼ ë°œì†¡
            List<User> targetUsers = [SELECT Id FROM User WHERE Alias = 'user17536916065362824897' AND IsActive = true LIMIT 1];
            if (!targetUsers.isEmpty()) {
                email.setTargetObjectId(targetUsers[0].Id);
            } else {
                email.setTargetObjectId(part.OwnerId); // Fallback to owner
            }
            email.setSaveAsActivity(false);
            
            emails.add(email);
        }
        
        if (!emails.isEmpty()) {
            try {
                Messaging.sendEmail(emails);
                System.debug('âœ… [PartsInventoryHandler] ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ: ' + emails.size() + 'ê±´');
            } catch (Exception e) {
                System.debug('âŒ [PartsInventoryHandler] ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ' + e.getMessage());
            }
        }
    }
}