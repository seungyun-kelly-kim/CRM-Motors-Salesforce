public with sharing class GoogleMapsController {
    
    // Named Credentialì„ í†µí•œ ë³´ì•ˆ API í˜¸ì¶œ
    private static final String NAMED_CREDENTIAL = 'callout:Google_Maps_API';
    private static final String PLACE_AUTOCOMPLETE_URL = NAMED_CREDENTIAL + '/maps/api/place/autocomplete/json';
    private static final String PLACE_DETAILS_URL = NAMED_CREDENTIAL + '/maps/api/place/details/json';
    private static final String GEOCODING_URL = NAMED_CREDENTIAL + '/maps/api/geocode/json';
    



    @AuraEnabled(cacheable=false)
    public static String getPlaceSuggestions(String input) {
        try {
            // Named Credentialì„ í†µí•œ ì•ˆì „í•œ API í˜¸ì¶œ
            // String url = PLACE_AUTOCOMPLETE_URL + 
            //             '?input=' + EncodingUtil.urlEncode(input, 'UTF-8') + 
            //             '&language=ko' + 
            //             '&components=country:kr';
            
            Http http = new Http();
            // HttpRequest request = new HttpRequest();
            // request.setEndpoint(url);
            // request.setMethod('GET');
            // request.setTimeout(10000);
            

            HttpRequest req = new HttpRequest();
            String endpoint = 'https://maps.googleapis.com/maps/api/place/details/json?place_id=' + EncodingUtil.urlEncode(input, 'UTF-8') + '&language=ko';
        
            // Named Credentialì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ ì •ë³´ ì²˜ë¦¬
            req.setEndpoint(URL.getOrgDomainUrl().toExternalForm() + '/services/apexrest/' + NAMED_CREDENTIAL + '/places/details?place_id=' + EncodingUtil.urlEncode(input, 'UTF-8'));
            req.setMethod('GET');
            System.debug(':ë‹ë³´ê¸°: Autocomplete ìš”ì²­ URL: ' + req.getEndpoint());
            HttpResponse response = http.send(req);
            
            if (response.getStatusCode() == 200) {
                return response.getBody();
            } else {
                System.debug('Google Places API Error: ' + response.getStatusCode() + ' - ' + response.getBody());
                // API í˜¸ì¶œ ì‹¤íŒ¨ì‹œ ë”ë¯¸ ë°ì´í„° ë°˜í™˜
                return getDummyPlaceSuggestions(input);
            }
            
        } catch (Exception e) {
            System.debug('Exception in getPlaceSuggestions: ' + e.getMessage());
            // ì˜ˆì™¸ ë°œìƒì‹œ ë”ë¯¸ ë°ì´í„° ë°˜í™˜ (ê°œë°œ/ë°ëª¨ ëª©ì )
            return getDummyPlaceSuggestions(input);
        }
    }
    
    @AuraEnabled(cacheable=false)
    public static String getPlaceDetails(String placeId) {
        try {
            // Named Credentialì„ í†µí•œ ì•ˆì „í•œ API í˜¸ì¶œ
            String url = PLACE_DETAILS_URL + 
                        '?place_id=' + EncodingUtil.urlEncode(placeId, 'UTF-8') + 
                        '&language=ko' + 
                        '&fields=name,formatted_address,geometry,address_components';
            
            Http http = new Http();
            HttpRequest request = new HttpRequest();
            request.setEndpoint(url);
            request.setMethod('GET');
            request.setTimeout(10000);
            
            HttpResponse response = http.send(request);
            
            if (response.getStatusCode() == 200) {
                return response.getBody();
            } else {
                System.debug('Google Place Details API Error: ' + response.getStatusCode() + ' - ' + response.getBody());
                // API í˜¸ì¶œ ì‹¤íŒ¨ì‹œ ë”ë¯¸ ë°ì´í„° ë°˜í™˜
                return getDummyPlaceDetails(placeId);
            }
            
        } catch (Exception e) {
            System.debug('Exception in getPlaceDetails: ' + e.getMessage());
            // ì˜ˆì™¸ ë°œìƒì‹œ ë”ë¯¸ ë°ì´í„° ë°˜í™˜ (ê°œë°œ/ë°ëª¨ ëª©ì )
            return getDummyPlaceDetails(placeId);
        }
    }
    
    // ì£¼ì†Œë¥¼ ìœ„ë„/ê²½ë„ë¡œ ë³€í™˜í•˜ëŠ” Geocoding API í˜¸ì¶œ
    @AuraEnabled(cacheable=true)
    public static Map<String, Decimal> getCoordinatesFromAddress(String address) {
        System.debug('ğŸŒ Geocoding ì‹œì‘ - ì£¼ì†Œ: ' + address);
        
        try {
            String url = GEOCODING_URL + 
                        '?address=' + EncodingUtil.urlEncode(address, 'UTF-8') + 
                        '&language=ko' + 
                        '&region=kr';
            
            System.debug('ğŸ”— API URL: ' + url);
            
            Http http = new Http();
            HttpRequest request = new HttpRequest();
            request.setEndpoint(url);
            request.setMethod('GET');
            request.setTimeout(10000);
            
            HttpResponse response = http.send(request);
            System.debug('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ: ' + response.getStatusCode());
            System.debug('ğŸ“¡ API ì‘ë‹µ ë³¸ë¬¸: ' + response.getBody());
            System.debug('ğŸ”— í˜¸ì¶œí•œ URL: ' + url);
            
            if (response.getStatusCode() == 200) {
                Map<String, Object> responseData = (Map<String, Object>) JSON.deserializeUntyped(response.getBody());
                String status = (String) responseData.get('status');
                System.debug('ğŸ” Google API Status: ' + status);
                
                if (status == 'OK') {
                    List<Object> results = (List<Object>) responseData.get('results');
                    
                    if (!results.isEmpty()) {
                        Map<String, Object> firstResult = (Map<String, Object>) results[0];
                        Map<String, Object> geometry = (Map<String, Object>) firstResult.get('geometry');
                        Map<String, Object> location = (Map<String, Object>) geometry.get('location');
                        
                        Decimal lat = (Decimal) location.get('lat');
                        Decimal lng = (Decimal) location.get('lng');
                        
                        System.debug('âœ… ì¢Œí‘œ ì¡°íšŒ ì„±ê³µ - Lat: ' + lat + ', Lng: ' + lng);
                        
                        return new Map<String, Decimal>{
                            'latitude' => lat,
                            'longitude' => lng
                        };
                    } else {
                        System.debug('âŒ Google API ê²°ê³¼ ì—†ìŒ');
                    }
                } else {
                    System.debug('âŒ Google API Status ì˜¤ë¥˜: ' + status);
                    if (responseData.containsKey('error_message')) {
                        System.debug('âŒ Error Message: ' + responseData.get('error_message'));
                    }
                }
            } else {
                System.debug('âŒ HTTP ì˜¤ë¥˜: ' + response.getStatusCode() + ' - ' + response.getBody());
            }
            
        } catch (Exception e) {
            System.debug('âŒ Exception in getCoordinatesFromAddress: ' + e.getMessage());
            System.debug('âŒ Stack Trace: ' + e.getStackTraceString());
        }
        
        System.debug('âŒ Google API ì‹¤íŒ¨ - ì¢Œí‘œ ì¡°íšŒ ë¶ˆê°€');
        // Google API ì‹¤íŒ¨ì‹œ null ë°˜í™˜ (í•˜ë“œì½”ë”© ë°±ì—… ì œê±°)
        return null;
    }
    
    
    // ì •ë¹„ì†Œ ë ˆì½”ë“œì˜ ìœ„ë„/ê²½ë„ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë©”ì„œë“œ
    @AuraEnabled
    public static void updateRepairShopCoordinates(Id repairShopId, String address) {
        try {
            System.debug('ğŸ”„ ì¢Œí‘œ ì—…ë°ì´íŠ¸ ì‹œì‘ - ID: ' + repairShopId + ', ì£¼ì†Œ: ' + address);
            
            // ì…ë ¥ ê²€ì¦
            if (String.isBlank(repairShopId) || String.isBlank(address)) {
                throw new AuraHandledException('ì •ë¹„ì†Œ IDì™€ ì£¼ì†ŒëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.');
            }
            
            // ì •ë¹„ì†Œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            List<Repair_Shop__c> existingShops = [
                SELECT Id, Name FROM Repair_Shop__c WHERE Id = :repairShopId LIMIT 1
            ];
            
            if (existingShops.isEmpty()) {
                throw new AuraHandledException('í•´ë‹¹ ì •ë¹„ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + repairShopId);
            }
            
            Map<String, Decimal> coordinates = getCoordinatesFromAddress(address);
            
            if (coordinates != null && coordinates.containsKey('latitude') && coordinates.containsKey('longitude')) {
                // í•„ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                Map<String, Schema.SObjectField> fieldMap = Schema.SObjectType.Repair_Shop__c.fields.getMap();
                
                if (!fieldMap.containsKey('Latitude__c') || !fieldMap.containsKey('Longitude__c')) {
                    throw new AuraHandledException('Repair_Shop__c ê°ì²´ì— Latitude__c ë˜ëŠ” Longitude__c í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤. Setupì—ì„œ í•„ë“œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                }
                
                Repair_Shop__c shop = new Repair_Shop__c(
                    Id = repairShopId
                );
                
                // ë™ì ìœ¼ë¡œ í•„ë“œê°’ ì„¤ì •
                shop.put('Latitude__c', coordinates.get('latitude'));
                shop.put('Longitude__c', coordinates.get('longitude'));
                
                update shop;
                System.debug('âœ… ì •ë¹„ì†Œ ì¢Œí‘œ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ' + existingShops[0].Name + 
                           ' (Lat: ' + coordinates.get('latitude') + 
                           ', Lng: ' + coordinates.get('longitude') + ')');
            } else {
                System.debug('âŒ ì¢Œí‘œ ì¡°íšŒ ì‹¤íŒ¨ - ì£¼ì†Œ: ' + address);
                throw new AuraHandledException('ì£¼ì†Œì—ì„œ ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + address);
            }
            
        } catch (DmlException e) {
            System.debug('âŒ DML ì˜¤ë¥˜: ' + e.getMessage());
            throw new AuraHandledException('ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: ' + e.getDmlMessage(0));
        } catch (Exception e) {
            System.debug('âŒ ì¼ë°˜ ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('âŒ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
            throw new AuraHandledException('ì¢Œí‘œ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    // ê°œë°œ/í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„° (API í˜¸ì¶œ ì‹¤íŒ¨ì‹œ ì‚¬ìš©)
    private static String getDummyPlaceSuggestions(String input) {
        Map<String, Object> response = new Map<String, Object>();
        List<Map<String, Object>> predictions = new List<Map<String, Object>>();
        
        // ì„œìš¸ ì§€ì—­ ë”ë¯¸ ë°ì´í„°
        if (input.contains('ì„œìš¸') || input.contains('ê°•ë‚¨') || input.contains('Seoul')) {
            predictions.add(new Map<String, Object>{
                'place_id' => 'dummy_gangnam_1',
                'description' => 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123',
                'structured_formatting' => new Map<String, Object>{
                    'main_text' => 'í…Œí—¤ë€ë¡œ 123',
                    'secondary_text' => 'ê°•ë‚¨êµ¬, ì„œìš¸íŠ¹ë³„ì‹œ'
                }
            });
            predictions.add(new Map<String, Object>{
                'place_id' => 'dummy_gangnam_2',
                'description' => 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 456',
                'structured_formatting' => new Map<String, Object>{
                    'main_text' => 'ì—­ì‚¼ë™ 456',
                    'secondary_text' => 'ê°•ë‚¨êµ¬, ì„œìš¸íŠ¹ë³„ì‹œ'
                }
            });
        } else if (input.contains('ë¶€ì‚°') || input.contains('Busan')) {
            predictions.add(new Map<String, Object>{
                'place_id' => 'dummy_busan_1',
                'description' => 'ë¶€ì‚°ê´‘ì—­ì‹œ í•´ìš´ëŒ€êµ¬ í•´ìš´ëŒ€ë¡œ 789',
                'structured_formatting' => new Map<String, Object>{
                    'main_text' => 'í•´ìš´ëŒ€ë¡œ 789',
                    'secondary_text' => 'í•´ìš´ëŒ€êµ¬, ë¶€ì‚°ê´‘ì—­ì‹œ'
                }
            });
        } else {
            // ê¸°ë³¸ ë”ë¯¸ ë°ì´í„°
            predictions.add(new Map<String, Object>{
                'place_id' => 'dummy_default_1',
                'description' => input + ' ê´€ë ¨ ì£¼ì†Œ 1',
                'structured_formatting' => new Map<String, Object>{
                    'main_text' => input + ' ê´€ë ¨ ì¥ì†Œ',
                    'secondary_text' => 'ì„œìš¸íŠ¹ë³„ì‹œ'
                }
            });
        }
        
        response.put('predictions', predictions);
        response.put('status', 'OK');
        
        return JSON.serialize(response);
    }
    
    private static String getDummyPlaceDetails(String placeId) {
        Map<String, Object> response = new Map<String, Object>();
        Map<String, Object> result = new Map<String, Object>();
        
        // placeIdì— ë”°ë¥¸ ë”ë¯¸ ìƒì„¸ ì •ë³´
        if (placeId == 'dummy_gangnam_1') {
            result.put('name', 'í…ŒìŠ¤íŠ¸ ì •ë¹„ì†Œ ê°•ë‚¨ì ');
            result.put('formatted_address', 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123');
            result.put('geometry', new Map<String, Object>{
                'location' => new Map<String, Object>{
                    'lat' => 37.5012767,
                    'lng' => 127.0396597
                }
            });
            result.put('address_components', new List<Map<String, Object>>{
                new Map<String, Object>{
                    'long_name' => '123',
                    'short_name' => '123',
                    'types' => new List<String>{'street_number'}
                },
                new Map<String, Object>{
                    'long_name' => 'í…Œí—¤ë€ë¡œ',
                    'short_name' => 'í…Œí—¤ë€ë¡œ',
                    'types' => new List<String>{'route'}
                },
                new Map<String, Object>{
                    'long_name' => 'ê°•ë‚¨êµ¬',
                    'short_name' => 'ê°•ë‚¨êµ¬',
                    'types' => new List<String>{'sublocality_level_1', 'sublocality', 'political'}
                },
                new Map<String, Object>{
                    'long_name' => 'ì„œìš¸íŠ¹ë³„ì‹œ',
                    'short_name' => 'ì„œìš¸',
                    'types' => new List<String>{'administrative_area_level_1', 'political'}
                },
                new Map<String, Object>{
                    'long_name' => 'ëŒ€í•œë¯¼êµ­',
                    'short_name' => 'KR',
                    'types' => new List<String>{'country', 'political'}
                },
                new Map<String, Object>{
                    'long_name' => '06234',
                    'short_name' => '06234',
                    'types' => new List<String>{'postal_code'}
                }
            });
        } else if (placeId == 'dummy_busan_1') {
            result.put('name', 'í…ŒìŠ¤íŠ¸ ì •ë¹„ì†Œ í•´ìš´ëŒ€ì ');
            result.put('formatted_address', 'ë¶€ì‚°ê´‘ì—­ì‹œ í•´ìš´ëŒ€êµ¬ í•´ìš´ëŒ€ë¡œ 789');
            result.put('geometry', new Map<String, Object>{
                'location' => new Map<String, Object>{
                    'lat' => 35.1595454,
                    'lng' => 129.1625941
                }
            });
            result.put('address_components', new List<Map<String, Object>>{
                new Map<String, Object>{
                    'long_name' => '789',
                    'short_name' => '789',
                    'types' => new List<String>{'street_number'}
                },
                new Map<String, Object>{
                    'long_name' => 'í•´ìš´ëŒ€ë¡œ',
                    'short_name' => 'í•´ìš´ëŒ€ë¡œ',
                    'types' => new List<String>{'route'}
                },
                new Map<String, Object>{
                    'long_name' => 'í•´ìš´ëŒ€êµ¬',
                    'short_name' => 'í•´ìš´ëŒ€êµ¬',
                    'types' => new List<String>{'sublocality_level_1', 'sublocality', 'political'}
                },
                new Map<String, Object>{
                    'long_name' => 'ë¶€ì‚°ê´‘ì—­ì‹œ',
                    'short_name' => 'ë¶€ì‚°',
                    'types' => new List<String>{'administrative_area_level_1', 'political'}
                },
                new Map<String, Object>{
                    'long_name' => 'ëŒ€í•œë¯¼êµ­',
                    'short_name' => 'KR',
                    'types' => new List<String>{'country', 'political'}
                },
                new Map<String, Object>{
                    'long_name' => '48094',
                    'short_name' => '48094',
                    'types' => new List<String>{'postal_code'}
                }
            });
        } else {
            // ê¸°ë³¸ ë”ë¯¸ ë°ì´í„°
            result.put('name', 'í…ŒìŠ¤íŠ¸ ì •ë¹„ì†Œ');
            result.put('formatted_address', 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123');
            result.put('geometry', new Map<String, Object>{
                'location' => new Map<String, Object>{
                    'lat' => 37.5665,
                    'lng' => 126.9780
                }
            });
            result.put('address_components', new List<Map<String, Object>>{
                new Map<String, Object>{
                    'long_name' => 'ì„œìš¸íŠ¹ë³„ì‹œ',
                    'short_name' => 'ì„œìš¸',
                    'types' => new List<String>{'administrative_area_level_1', 'political'}
                },
                new Map<String, Object>{
                    'long_name' => 'ëŒ€í•œë¯¼êµ­',
                    'short_name' => 'KR',
                    'types' => new List<String>{'country', 'political'}
                }
            });
        }
        
        response.put('result', result);
        response.put('status', 'OK');
        
        return JSON.serialize(response);
    }
}