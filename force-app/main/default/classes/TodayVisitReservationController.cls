public with sharing class TodayVisitReservationController {
    
    @AuraEnabled(cacheable=false)
    public static List<Case> getTodayVisitReservations() {
        try {
            // ì˜¤ëŠ˜ ë‚ ì§œ ë²”ìœ„ë¡œ í•„í„°ë§ (DateTime í•„ë“œ ëŒ€ì‘)
            DateTime startOfToday = DateTime.newInstance(Date.today(), Time.newInstance(0, 0, 0, 0));
            DateTime endOfToday = DateTime.newInstance(Date.today(), Time.newInstance(23, 59, 59, 0));
            
            System.debug('ğŸ” [TodayVisit] ì˜¤ëŠ˜ ë‚ ì§œ: ' + Date.today());
            System.debug('ğŸ” [TodayVisit] ì¡°íšŒ ë²”ìœ„: ' + startOfToday + ' ~ ' + endOfToday);
            
            // ë¨¼ì € ëª¨ë“  Case ìˆ˜ í™•ì¸
            Integer totalCases = [SELECT COUNT() FROM Case];
            System.debug('ğŸ” [TodayVisit] ì „ì²´ Case ìˆ˜: ' + totalCases);
            
            // Preferred_Date__cê°€ ìˆëŠ” Case ìˆ˜ í™•ì¸
            Integer casesWithPreferredDate = [SELECT COUNT() FROM Case WHERE Preferred_Date__c != null];
            System.debug('ğŸ” [TodayVisit] Preferred_Date__cê°€ ìˆëŠ” Case ìˆ˜: ' + casesWithPreferredDate);
            
            // ìµœê·¼ 5ê°œ Caseì˜ Preferred_Date__c ê°’ í™•ì¸
            List<Case> recentCases = [
                SELECT Id, CaseNumber, Preferred_Date__c, Status, CreatedDate
                FROM Case 
                WHERE Preferred_Date__c != null
                ORDER BY CreatedDate DESC 
                LIMIT 5
            ];
            System.debug('ğŸ” [TodayVisit] ìµœê·¼ 5ê°œ Case:');
            for (Case c : recentCases) {
                System.debug('  - ' + c.CaseNumber + ': ' + c.Preferred_Date__c + ' (Status: ' + c.Status + ')');
            }
            
            // ì¼€ì´ìŠ¤ ì¡°íšŒ (Status ì¡°ê±´ ì™„í™”)
            List<Case> todayReservations = [
                SELECT Id,
                       CaseNumber,
                       Subject,
                       Status,
                       Preferred_Date__c,
                       ServiceReservationType__c,
                       ContactPhone,
                       Contact.Name,
                       Account.Name,
                       TechnicianPerCase__r.Name
                FROM Case
                WHERE Preferred_Date__c >= :startOfToday
                  AND Preferred_Date__c <= :endOfToday
                  AND (Status = 'New' OR Status = 'Working' OR Status = 'ë°°ì •')
                ORDER BY Preferred_Date__c ASC
                LIMIT 50
            ];
            
            System.debug('ğŸ” [TodayVisit] ì¡°íšŒëœ ì˜¤ëŠ˜ ì¼€ì´ìŠ¤ ìˆ˜: ' + todayReservations.size());
            
            return todayReservations;
            
        } catch (Exception e) {
            System.debug('Error: ' + e.getMessage());
            System.debug('Stack Trace: ' + e.getStackTraceString());
            throw new AuraHandledException('ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
        }
    }
    
    @AuraEnabled(cacheable=true)
    public static List<Map<String, String>> getRepairShops() {
        try {
            List<Map<String, String>> repairShopOptions = new List<Map<String, String>>();
            
            List<Repair_Shop__c> repairShops = [
                SELECT Id, Name, Address__c, Phone_Number__c
                FROM Repair_Shop__c
                ORDER BY Name ASC
            ];
            
            for (Repair_Shop__c shop : repairShops) {
                repairShopOptions.add(new Map<String, String>{
                    'label' => shop.Name,
                    'value' => shop.Id,
                    'address' => shop.Address__c,
                    'phone' => shop.Phone_Number__c
                });
            }
            
            return repairShopOptions;
            
        } catch (Exception e) {
            throw new AuraHandledException('ì •ë¹„ì†Œ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    @AuraEnabled
    public static String assignTechnician(String caseId, String technicianId) {
        if (String.isBlank(caseId) || String.isBlank(technicianId)) {
            throw new AuraHandledException('ì¼€ì´ìŠ¤ IDì™€ ì •ë¹„ì‚¬ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        }
        
        try {
            Case caseToUpdate = [
                SELECT Id, TechnicianPerCase__c
                FROM Case
                WHERE Id = :caseId
                LIMIT 1
            ];
            
            caseToUpdate.TechnicianPerCase__c = technicianId;
            update caseToUpdate;
            
            return 'ì •ë¹„ì‚¬ê°€ ì„±ê³µì ìœ¼ë¡œ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.';
            
        } catch (DmlException e) {
            throw new AuraHandledException('ì •ë¹„ì‚¬ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getDmlMessage(0));
        } catch (QueryException e) {
            throw new AuraHandledException('ì¼€ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e.getMessage());
        } catch (Exception e) {
            throw new AuraHandledException('ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
}