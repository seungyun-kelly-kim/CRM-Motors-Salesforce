public with sharing class RepairReservationScheduler {
    public class TimeSlotWrapper {
        @AuraEnabled public String label;
        @AuraEnabled public Integer remaining;
        @AuraEnabled public String startTime;

        public TimeSlotWrapper(String label, Integer remaining, String startTime) {
            this.label = label;
            this.remaining = remaining;
            this.startTime = startTime;
        }
    }

    // âœ… STEP.5 ì‹œê°„ ìŠ¬ë¡¯ ì¡°íšŒ
    @AuraEnabled(cacheable=true)
    public static List<TimeSlotWrapper> getAvailableTimeSlots(Date selectedDate, Id repairShopId, String selectedDetails) {
        List<TimeSlotWrapper> result = new List<TimeSlotWrapper>();
        String[] weekdays = new List<String>{'ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '};
        Integer dayIndex = (Integer)selectedDate.toStartOfWeek().daysBetween(selectedDate);
        String dayOfWeek = weekdays[dayIndex];

        List<OperatingHours__c> ops = [
            SELECT Id, StartOperation__c, EndOperation__c
            FROM OperatingHours__c
            WHERE OperationRepairShop__c = :repairShopId AND Name = :dayOfWeek
        ];
        if (ops.isEmpty()) return result;

        OperatingHours__c op = ops[0];
        Time startTime = op.StartOperation__c;
        Time endTime = op.EndOperation__c;

        // âœ… ìŠ¤í‚¬ ê¸°ë°˜ ê¸°ìˆ ì í•„í„°ë§
        Set<String> requiredSkills = getRequiredSkills(selectedDetails);
        System.debug('ğŸ› ï¸ [ì‹œê°„ìŠ¬ë¡¯] selectedDetails: ' + selectedDetails);
        System.debug('ğŸ› ï¸ [ì‹œê°„ìŠ¬ë¡¯] í•„ìš”í•œ ìŠ¤í‚¬: ' + requiredSkills);
        
        Set<Id> qualifiedTechIds = new Set<Id>();
        
        if (requiredSkills.isEmpty()) {
            // ìŠ¤í‚¬ ìš”êµ¬ì‚¬í•­ì´ ì—†ìœ¼ë©´ ëª¨ë“  ê·¼ë¬´ ê¸°ìˆ ì í¬í•¨
            List<WorkingHour__c> working = [
                SELECT SelectTechnician__c
                FROM WorkingHour__c
                WHERE OperationTechnician__c = :op.Id
            ];
            for (WorkingHour__c wh : working) {
                qualifiedTechIds.add(wh.SelectTechnician__c);
            }
        } else {
            // í•„ìš”í•œ ìŠ¤í‚¬ì„ ê°€ì§„ ê¸°ìˆ ìë§Œ í¬í•¨
            List<TechnicianSkillset__c> techSkills = [
                SELECT SkillsetTechnician__c, SkillsetperTechnician__r.Name
                FROM TechnicianSkillset__c
                WHERE SkillsetTechnician__r.TechnicianRepairShop__c = :repairShopId
                AND SkillsetperTechnician__r.Name IN :requiredSkills
            ];
            System.debug('ğŸ” [ì‹œê°„ìŠ¬ë¡¯] ì¡°íšŒëœ TechnicianSkillset ìˆ˜: ' + techSkills.size());
            System.debug('ğŸ” [ì‹œê°„ìŠ¬ë¡¯] repairShopId: ' + repairShopId);
            
            // ìŠ¤í‚¬ì„ ê°€ì§„ ì •ë¹„ì‚¬ë“¤ì„ ê·¸ë£¹í•‘
            Map<Id, Set<String>> techSkillMap = new Map<Id, Set<String>>();
            for (TechnicianSkillset__c ts : techSkills) {
                if (!techSkillMap.containsKey(ts.SkillsetTechnician__c)) {
                    techSkillMap.put(ts.SkillsetTechnician__c, new Set<String>());
                }
                techSkillMap.get(ts.SkillsetTechnician__c).add(ts.SkillsetperTechnician__r.Name);
            }
            
            // ëª¨ë“  í•„ìš”í•œ ìŠ¤í‚¬ì„ ê°€ì§„ ì •ë¹„ì‚¬ë§Œ ì„ íƒí•˜ê³ , í•´ë‹¹ ë‚ ì§œì— ê·¼ë¬´í•˜ëŠ”ì§€ í™•ì¸
            List<WorkingHour__c> working = [
                SELECT SelectTechnician__c
                FROM WorkingHour__c
                WHERE OperationTechnician__c = :op.Id
            ];
            Set<Id> workingTechIds = new Set<Id>();
            for (WorkingHour__c wh : working) {
                workingTechIds.add(wh.SelectTechnician__c);
            }
            
            for (Id techId : techSkillMap.keySet()) {
                Set<String> techSkillSet = techSkillMap.get(techId);
                if (techSkillSet.containsAll(requiredSkills) && workingTechIds.contains(techId)) {
                    qualifiedTechIds.add(techId);
                }
            }
        }
        
        if (qualifiedTechIds.isEmpty()) return result;
        System.debug('ğŸ‘¨â€ğŸ”§ [ì‹œê°„ìŠ¬ë¡¯] ì í•©í•œ ê¸°ìˆ ì ìˆ˜: ' + qualifiedTechIds.size());

        DateTime startOfDay = DateTime.newInstance(selectedDate, Time.newInstance(0,0,0,0));
        DateTime endOfDay = DateTime.newInstance(selectedDate, Time.newInstance(23,59,59,0));

        List<Case> existingCases = [
            SELECT Preferred_Date__c, TechnicianPerCase__c
            FROM Case
            WHERE TechnicianPerCase__c IN :qualifiedTechIds
              AND Preferred_Date__c >= :startOfDay AND Preferred_Date__c <= :endOfDay
        ];

        Map<Time, Integer> slotCount = new Map<Time, Integer>();
        for (Case c : existingCases) {
            Time slotTime = Time.newInstance(c.Preferred_Date__c.hour(), c.Preferred_Date__c.minute(), 0, 0);
            slotCount.put(slotTime, slotCount.containsKey(slotTime) ? slotCount.get(slotTime) + 1 : 1);
        }

        for (Time t = startTime; t.addMinutes(90) <= endTime; t = t.addMinutes(90)) {
            if (t >= Time.newInstance(13,0,0,0) && t < Time.newInstance(14,30,0,0)) continue;

            Time tEnd = t.addMinutes(90);
            String label = pad(t.hour()) + ':' + pad(t.minute()) + ' - ' + pad(tEnd.hour()) + ':' + pad(tEnd.minute());
            Integer used = slotCount.containsKey(t) ? slotCount.get(t) : 0;
            Integer remaining = qualifiedTechIds.size() - used;

            result.add(new TimeSlotWrapper(label, remaining, pad(t.hour()) + ':' + pad(t.minute())));
        }
        return result;
    }

    private static String pad(Integer n) {
        return n < 10 ? '0' + String.valueOf(n) : String.valueOf(n);
    }
    
    // âœ… ì„¸ë¶€ ì •ë¹„ í•­ëª©ì—ì„œ ê¸°ìˆ  ì—­ëŸ‰ ë§¤í•‘
    private static Set<String> getRequiredSkills(String selectedDetails) {
        Set<String> requiredSkills = new Set<String>();
        
        System.debug('ğŸ” [getRequiredSkills] ì…ë ¥ë°›ì€ selectedDetails: "' + selectedDetails + '"');
        System.debug('ğŸ” [getRequiredSkills] selectedDetailsê°€ nullì¸ê°€?: ' + (selectedDetails == null));
        System.debug('ğŸ” [getRequiredSkills] selectedDetailsê°€ blankì¸ê°€?: ' + String.isBlank(selectedDetails));
        
        if (String.isBlank(selectedDetails)) {
            System.debug('âš ï¸ [getRequiredSkills] selectedDetailsê°€ ë¹„ì–´ìˆì–´ì„œ ë¹ˆ ìŠ¤í‚¬ ì…‹ ë°˜í™˜');
            return requiredSkills;
        }
        
        List<String> detailsList = selectedDetails.split(';');
        System.debug('ğŸ” [getRequiredSkills] ë¶„í• ëœ detailsList: ' + detailsList);
        System.debug('ğŸ” [getRequiredSkills] detailsList í¬ê¸°: ' + detailsList.size());
        
        for (String detail : detailsList) {
            String trimmedDetail = detail.trim();
            System.debug('ğŸ” [getRequiredSkills] ì²˜ë¦¬ ì¤‘ì¸ detail: "' + trimmedDetail + '"');
            
            // ì—”ì§„ ê´€ë ¨ ì—­ëŸ‰
            if (trimmedDetail == 'engine_problem' || trimmedDetail == 'noise_vibration' || trimmedDetail == 'engine_oil_filter') {
                requiredSkills.add('ì—”ì§„');
                System.debug('âœ… [getRequiredSkills] ì—”ì§„ ìŠ¤í‚¬ ì¶”ê°€ë¨');
            }
            // ë³€ì†ê¸° ê´€ë ¨ ì—­ëŸ‰
            else if (trimmedDetail == 'transmission' || trimmedDetail == 'transmission_oil') {
                requiredSkills.add('ë³€ì†ê¸°');
                System.debug('âœ… [getRequiredSkills] ë³€ì†ê¸° ìŠ¤í‚¬ ì¶”ê°€ë¨');
            }
            // ì „ì¥ ê´€ë ¨ ì—­ëŸ‰
            else if (trimmedDetail == 'fuse_lamp_battery' || trimmedDetail == 'warning_lights') {
                requiredSkills.add('ì „ì¥(ì „ê¸°/ì „ì¥í’ˆ)');
                System.debug('âœ… [getRequiredSkills] ì „ì¥ ìŠ¤í‚¬ ì¶”ê°€ë¨');
            }
            // ì†Œëª¨í’ˆ/ê²½ì •ë¹„ ê´€ë ¨ ì—­ëŸ‰
            else if (trimmedDetail == 'wiper_blades' || trimmedDetail == 'air_conditioning_refrigerant' || 
                     trimmedDetail == 'washer_fluid_coolant' || trimmedDetail == 'other_consumables') {
                requiredSkills.add('ì†Œëª¨í’ˆ/ê²½ì •ë¹„');
                System.debug('âœ… [getRequiredSkills] ì†Œëª¨í’ˆ/ê²½ì •ë¹„ ìŠ¤í‚¬ ì¶”ê°€ë¨');
            }
            // HVAC ê´€ë ¨ ì—­ëŸ‰ (ì—ì–´ì»¨ ëƒ‰ë§¤ëŠ” ë‘ ì¹´í…Œê³ ë¦¬ì— í¬í•¨ë  ìˆ˜ ìˆìŒ)
            else if (trimmedDetail == 'air_conditioning_refrigerant') {
                requiredSkills.add('ì—ì–´ì»¨/HVAC');
                System.debug('âœ… [getRequiredSkills] ì—ì–´ì»¨/HVAC ìŠ¤í‚¬ ì¶”ê°€ë¨');
            }
            else {
                System.debug('âš ï¸ [getRequiredSkills] ë§¤ì¹­ë˜ì§€ ì•Šì€ detail: "' + trimmedDetail + '"');
            }
        }
        
        System.debug('ğŸ› ï¸ [getRequiredSkills] ìµœì¢… requiredSkills: ' + requiredSkills);
        return requiredSkills;
    }
    
    // âœ… í•´ë‹¹ ì •ë¹„ì†Œì—ì„œ í•„ìš”í•œ ìŠ¤í‚¬ì„ ê°€ì§„ ì •ë¹„ì‚¬ ì¡°íšŒ
    private static List<Id> getQualifiedTechnicians(Id repairShopId, Set<String> requiredSkills, DateTime preferredDateTime) {
        List<Id> qualifiedTechIds = new List<Id>();
        
        if (requiredSkills.isEmpty()) {
            return qualifiedTechIds;
        }
        
        // 1. í•´ë‹¹ ì •ë¹„ì†Œì˜ ì •ë¹„ì‚¬ë“¤ ì¤‘ì—ì„œ í•„ìš”í•œ ìŠ¤í‚¬ì„ ê°€ì§„ ì •ë¹„ì‚¬ ì¡°íšŒ
        List<TechnicianSkillset__c> techSkills = [
            SELECT SkillsetTechnician__c, SkillsetperTechnician__r.Name
            FROM TechnicianSkillset__c
            WHERE SkillsetTechnician__r.TechnicianRepairShop__c = :repairShopId
            AND SkillsetperTechnician__r.Name IN :requiredSkills
        ];
        
        // 2. ìŠ¤í‚¬ì„ ê°€ì§„ ì •ë¹„ì‚¬ë“¤ì„ ê·¸ë£¹í•‘
        Map<Id, Set<String>> techSkillMap = new Map<Id, Set<String>>();
        for (TechnicianSkillset__c ts : techSkills) {
            if (!techSkillMap.containsKey(ts.SkillsetTechnician__c)) {
                techSkillMap.put(ts.SkillsetTechnician__c, new Set<String>());
            }
            techSkillMap.get(ts.SkillsetTechnician__c).add(ts.SkillsetperTechnician__r.Name);
        }
        
        // 3. ëª¨ë“  í•„ìš”í•œ ìŠ¤í‚¬ì„ ê°€ì§„ ì •ë¹„ì‚¬ë§Œ ì„ íƒ
        for (Id techId : techSkillMap.keySet()) {
            Set<String> techSkillSet = techSkillMap.get(techId);
            if (techSkillSet.containsAll(requiredSkills)) {
                // 4. í•´ë‹¹ ì‹œê°„ì— ë‹¤ë¥¸ ì¼€ì´ìŠ¤ê°€ ë°°ì •ë˜ì§€ ì•Šì€ ì •ë¹„ì‚¬ë§Œ ì„ íƒ
                if (isTechnicianAvailable(techId, preferredDateTime)) {
                    qualifiedTechIds.add(techId);
                }
            }
        }
        
        return qualifiedTechIds;
    }
    
    // âœ… í•´ë‹¹ ì‹œê°„ì— ì •ë¹„ì‚¬ê°€ ì´ìš© ê°€ëŠ¥í•œì§€ í™•ì¸
    private static Boolean isTechnicianAvailable(Id technicianId, DateTime preferredDateTime) {
        // 90ë¶„ ìŠ¬ë¡¯ ê¸°ì¤€ìœ¼ë¡œ ê²¹ì¹˜ëŠ” ì‹œê°„ëŒ€ ì²´í¬
        DateTime slotStart = preferredDateTime;
        DateTime slotEnd = preferredDateTime.addMinutes(90);
        
        List<Case> conflictCases = [
            SELECT Id
            FROM Case
            WHERE TechnicianPerCase__c = :technicianId
            AND Preferred_Date__c >= :slotStart.addMinutes(-90)  // ì´ì „ ìŠ¬ë¡¯ê³¼ ê²¹ì¹˜ëŠ” ê²½ìš°
            AND Preferred_Date__c < :slotEnd  // ë‹¤ìŒ ìŠ¬ë¡¯ê³¼ ê²¹ì¹˜ëŠ” ê²½ìš°
        ];
        
        return conflictCases.isEmpty();
    }

    // âœ… ì •ë¹„ì‚¬ ë¯¸ë¦¬ë³´ê¸° ì •ë³´ë¥¼ ë‹´ëŠ” ë˜í¼ í´ë˜ìŠ¤
    public class TechnicianPreviewResult {
        @AuraEnabled public String technicianName;
        @AuraEnabled public String technicianId;
        @AuraEnabled public Boolean available;
        @AuraEnabled public String message;
        
        public TechnicianPreviewResult(String technicianName, String technicianId, Boolean available, String message) {
            this.technicianName = technicianName;
            this.technicianId = technicianId;
            this.available = available;
            this.message = message;
        }
    }

    // âœ… STEP.6 ì •ë¹„ì‚¬ ë¯¸ë¦¬ ì¡°íšŒ (Case ìƒì„± ì „)
    @AuraEnabled(cacheable=true)
    public static TechnicianPreviewResult previewTechnicianAssignment(
        Id repairShopId,
        String preferredDate,
        String selectedDetails
    ) {
        System.debug('ğŸ” [ë¯¸ë¦¬ë³´ê¸°] ì •ë¹„ì‚¬ ì¡°íšŒ ì‹œì‘');
        
        try {
            DateTime parsedDateTime;
            // ë‚ ì§œ íŒŒì‹±
            List<String> parts = preferredDate.split(' ');
            List<String> dateParts = parts[0].split('-');
            List<String> timeParts = parts[1].split(':');
            
            Integer year = Integer.valueOf(dateParts[0]);
            Integer month = Integer.valueOf(dateParts[1]);
            Integer day = Integer.valueOf(dateParts[2]);
            Integer hour = Integer.valueOf(timeParts[0]);
            Integer minute = Integer.valueOf(timeParts[1]);
            Integer second = Integer.valueOf(timeParts[2]);
            
            parsedDateTime = DateTime.newInstance(year, month, day, hour, minute, second);
            
            Set<String> requiredSkills = getRequiredSkills(selectedDetails);
            List<Id> qualifiedTechnicians = getQualifiedTechnicians(repairShopId, requiredSkills, parsedDateTime);
            
            if (!qualifiedTechnicians.isEmpty()) {
                // ëœë¤ìœ¼ë¡œ ì •ë¹„ì‚¬ ì„ íƒ
                Integer randomIndex = Math.mod(Math.abs(Crypto.getRandomInteger()), qualifiedTechnicians.size());
                Id selectedTechnicianId = qualifiedTechnicians[randomIndex];
                
                // ì •ë¹„ì‚¬ ì´ë¦„ ì¡°íšŒ
                List<Technician__c> techs = [
                    SELECT Name
                    FROM Technician__c 
                    WHERE Id = :selectedTechnicianId
                    LIMIT 1
                ];
                
                String technicianName = !techs.isEmpty() ? techs[0].Name : 'ì •ë¹„ì‚¬';
                
                return new TechnicianPreviewResult(
                    technicianName,
                    selectedTechnicianId,
                    true,
                    technicianName + ' ì •ë¹„ì‚¬ê°€ ë°°ì • ì˜ˆì •ì…ë‹ˆë‹¤.'
                );
            } else {
                return new TechnicianPreviewResult(
                    null,
                    null,
                    false,
                    'í˜„ì¬ ì‹œê°„ëŒ€ì— ê°€ëŠ¥í•œ ì •ë¹„ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'
                );
            }
        } catch (Exception e) {
            System.debug('âŒ ì •ë¹„ì‚¬ ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨: ' + e.getMessage());
            return new TechnicianPreviewResult(
                null,
                null,
                false,
                'ì •ë¹„ì‚¬ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
            );
        }
    }

    // âœ… ë°°ì •ëœ ì •ë¹„ì‚¬ ì •ë³´ë¥¼ ë‹´ëŠ” ë˜í¼ í´ë˜ìŠ¤
    public class TechnicianAssignmentResult {
        @AuraEnabled public String technicianName;
        @AuraEnabled public String technicianId;
        @AuraEnabled public Boolean success;
        @AuraEnabled public String message;
        
        public TechnicianAssignmentResult(String technicianName, String technicianId, Boolean success, String message) {
            this.technicianName = technicianName;
            this.technicianId = technicianId;
            this.success = success;
            this.message = message;
        }
    }

    // âœ… STEP.6 ì˜ˆì•½ ë° ê¸°ìˆ ì ë°°ì • (ì •ë¹„ì‚¬ ì •ë³´ ë°˜í™˜)
    @AuraEnabled
    public static TechnicianAssignmentResult assignTechnicianAndCreateCase(
        Id accountId,
        Id assetId,
        Id repairShopId,
        String preferredDate,
        String selectedDetails,
        String serviceType,
        String serviceTypeValue,
        String description
    ) {
        System.debug('ğŸš€ [assignTechnicianAndCreateCase] ì‹œì‘');
        System.debug('ğŸ“ preferredDate íŒŒë¼ë¯¸í„°: ' + preferredDate);
        System.debug('ğŸ“ selectedDetails: ' + selectedDetails);
        System.debug('ğŸ“ serviceType: ' + serviceType);

        DateTime parsedDateTime;
        try {
            System.debug('ğŸ• ì…ë ¥ë°›ì€ ë‚ ì§œ ë¬¸ìì—´: ' + preferredDate);
            
            // ë¬¸ìì—´ì„ ì§ì ‘ íŒŒì‹±í•´ì„œ í•œêµ­ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ DateTime ìƒì„±
            // í˜•ì‹: "2025-07-31 17:30:00"
            List<String> parts = preferredDate.split(' ');
            List<String> dateParts = parts[0].split('-');
            List<String> timeParts = parts[1].split(':');
            
            Integer year = Integer.valueOf(dateParts[0]);
            Integer month = Integer.valueOf(dateParts[1]);
            Integer day = Integer.valueOf(dateParts[2]);
            Integer hour = Integer.valueOf(timeParts[0]);
            Integer minute = Integer.valueOf(timeParts[1]);
            Integer second = Integer.valueOf(timeParts[2]);
            
            // í•œêµ­ ì‹œê°„ëŒ€ë¡œ ì§ì ‘ ìƒì„± (TimeZone ë³€í™˜ ì—†ìŒ)
            parsedDateTime = DateTime.newInstance(year, month, day, hour, minute, second);
            
            System.debug('ğŸ• ì§ì ‘ íŒŒì‹±ëœ DateTime (KST): ' + parsedDateTime);
            System.debug('ğŸŒ í˜„ì¬ ì‚¬ìš©ì TimeZone: ' + UserInfo.getTimeZone().getID());
        } catch (Exception e) {
            System.debug('âŒ DateTime íŒŒì‹± ì‹¤íŒ¨: ' + e.getMessage());
            throw new AuraHandledException('ë‚ ì§œ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // Asset ì´ë¦„ ì¡°íšŒ
        String assetName = 'ì°¨ëŸ‰';
        try {
            List<Asset> assets = [
                SELECT Name 
                FROM Asset 
                WHERE AccountId = :accountId 
                ORDER BY CreatedDate DESC 
                LIMIT 1
            ];
            if (!assets.isEmpty()) {
                assetName = assets[0].Name;
            }
        } catch (Exception e) {
            System.debug('Asset ì¡°íšŒ ì‹¤íŒ¨: ' + e.getMessage());
        }

        // âœ… ìŠ¤í‚¬ ê¸°ë°˜ ì •ë¹„ì‚¬ ë°°ì • ë¡œì§
        Set<String> requiredSkills = getRequiredSkills(selectedDetails);
        System.debug('ğŸ› ï¸ í•„ìš”í•œ ìŠ¤í‚¬: ' + requiredSkills);
        
        List<Id> qualifiedTechnicians = getQualifiedTechnicians(repairShopId, requiredSkills, parsedDateTime);
        System.debug('ğŸ‘¨â€ğŸ”§ ì í•©í•œ ì •ë¹„ì‚¬ ìˆ˜: ' + qualifiedTechnicians.size());
        
        Id assignedTechnicianId = null;
        String assignedTechnicianName = null;
        String caseStatus = 'New';
        
        if (!qualifiedTechnicians.isEmpty()) {
            // ëœë¤ìœ¼ë¡œ ì •ë¹„ì‚¬ ì„ íƒ
            Integer randomIndex = Math.mod(Math.abs(Crypto.getRandomInteger()), qualifiedTechnicians.size());
            assignedTechnicianId = qualifiedTechnicians[randomIndex];
            caseStatus = 'ë°°ì •';
            
            // ë°°ì •ëœ ì •ë¹„ì‚¬ ì´ë¦„ ì¡°íšŒ
            try {
                List<Technician__c> techs = [
                    SELECT Name
                    FROM Technician__c 
                    WHERE Id = :assignedTechnicianId
                    LIMIT 1
                ];
                if (!techs.isEmpty()) {
                    assignedTechnicianName = techs[0].Name;
                }
            } catch (Exception e) {
                System.debug('ì •ë¹„ì‚¬ ì´ë¦„ ì¡°íšŒ ì‹¤íŒ¨: ' + e.getMessage());
                assignedTechnicianName = 'ì •ë¹„ì‚¬';
            }
            
            System.debug('âœ… ë°°ì •ëœ ì •ë¹„ì‚¬: ' + assignedTechnicianId + ' (' + assignedTechnicianName + ')');
        } else {
            System.debug('âš ï¸ ì í•©í•œ ì •ë¹„ì‚¬ê°€ ì—†ì–´ì„œ ìˆ˜ë™ ë°°ì • í•„ìš”');
            caseStatus = 'New';
        }

        Case c = new Case(
            AccountId = accountId,
            AssetId = assetId,
            Repair_Shop__c = repairShopId,
            TechnicianPerCase__c = assignedTechnicianId,
            Preferred_Date__c = parsedDateTime,
            Status = caseStatus,
            Subject = '[' + String.valueOf(parsedDateTime.date()) + '] ' + assetName,
            Service_Type__c = serviceTypeValue,
            ServiceReservationType__c = serviceType,
            ServiceReservationTypeDetails__c = selectedDetails,
            Description = description,
            Origin = 'Web'
        );

        try {
            insert c;
            System.debug('âœ… Case ìƒì„± ì„±ê³µ: ' + c.Id);
            System.debug('ğŸ“Š ìµœì¢… ìƒíƒœ - Status: ' + caseStatus + ', ì •ë¹„ì‚¬: ' + assignedTechnicianId);
            
            // ì„±ê³µ ê²°ê³¼ ë°˜í™˜
            if (assignedTechnicianId != null && assignedTechnicianName != null) {
                return new TechnicianAssignmentResult(
                    assignedTechnicianName,
                    assignedTechnicianId,
                    true,
                    assignedTechnicianName + ' ì •ë¹„ì‚¬ê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'
                );
            } else {
                return new TechnicianAssignmentResult(
                    null,
                    null,
                    true,
                    'ì˜ˆì•½ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì •ë¹„ì‚¬ëŠ” ì¶”í›„ ë°°ì •ë  ì˜ˆì •ì…ë‹ˆë‹¤.'
                );
            }
        } catch (DmlException e) {
            System.debug('âŒ DML ì‹¤íŒ¨: ' + e.getMessage());
            return new TechnicianAssignmentResult(
                null,
                null,
                false,
                'ì˜ˆì•½ ì ‘ìˆ˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getDmlMessage(0)
            );
        }
    }

    // âœ… Picklist ë¼ë²¨ ë§¤í•‘ ì¡°íšŒ
    @AuraEnabled(cacheable=true)
    public static Map<String, String> getPicklistLabelMap(String objectName, String fieldName) {
        Map<String, String> labelMap = new Map<String, String>();
        
        try {
            Schema.SObjectType targetType = Schema.getGlobalDescribe().get(objectName);
            Schema.DescribeSObjectResult describe = targetType.getDescribe();
            Schema.DescribeFieldResult fieldDescribe = describe.fields.getMap().get(fieldName).getDescribe();
            
            for (Schema.PicklistEntry entry : fieldDescribe.getPicklistValues()) {
                if (entry.isActive()) {
                    labelMap.put(entry.getValue(), entry.getLabel());
                }
            }
        } catch (Exception e) {
            System.debug('Error getting picklist label map: ' + e.getMessage());
        }
        
        return labelMap;
    }
}