public with sharing class RepairShopController {
    
    @AuraEnabled(cacheable=true)
    public static List<Map<String, String>> getProvinceOptions() {
        List<Map<String, String>> options = new List<Map<String, String>>();
        
        try {
            Schema.DescribeFieldResult fieldResult = Repair_Shop__c.Province__c.getDescribe();
            List<Schema.PicklistEntry> picklistValues = fieldResult.getPicklistValues();
            
            for(Schema.PicklistEntry entry : picklistValues) {
                if(entry.isActive()) {
                    Map<String, String> option = new Map<String, String>();
                    option.put('label', entry.getLabel());
                    option.put('value', entry.getValue());
                    options.add(option);
                }
            }
        } catch(Exception e) {
            System.debug('Error getting province options: ' + e.getMessage());
        }
        
        return options;
    }
    
    @AuraEnabled(cacheable=true)
    public static List<Repair_Shop__c> getRepairShops(String province, String city) {
        List<Repair_Shop__c> repairShops = new List<Repair_Shop__c>();
        
        try {
            // í•„ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            Map<String, Schema.SObjectField> fieldMap = Schema.SObjectType.Repair_Shop__c.fields.getMap();
            Boolean hasCoordinateFields = fieldMap.containsKey('Latitude__c') && fieldMap.containsKey('Longitude__c');
            
            if (hasCoordinateFields) {
                repairShops = [
                    SELECT Id, Name, Address__c, Province__c, City__c, Phone_Number__c, Latitude__c, Longitude__c
                    FROM Repair_Shop__c 
                    WHERE Province__c = :province AND City__c = :city
                    ORDER BY Name
                ];
            } else {
                System.debug('âš ï¸ Latitude__c ë˜ëŠ” Longitude__c í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ í•„ë“œë§Œ ì¡°íšŒí•©ë‹ˆë‹¤.');
                repairShops = [
                    SELECT Id, Name, Address__c, Province__c, City__c, Phone_Number__c
                    FROM Repair_Shop__c 
                    WHERE Province__c = :province AND City__c = :city
                    ORDER BY Name
                ];
                
                // ì¢Œí‘œ í•„ë“œê°€ ì—†ëŠ” ê²½ìš° nullë¡œ ì„¤ì •
                for (Repair_Shop__c shop : repairShops) {
                    shop.put('Latitude__c', null);
                    shop.put('Longitude__c', null);
                }
            }
            
            System.debug('ğŸ“Š ì¡°íšŒëœ ì •ë¹„ì†Œ ìˆ˜: ' + repairShops.size());
            
            // ğŸ¯ í•µì‹¬: ì˜ëª»ëœ ì¢Œí‘œë¥¼ ê°€ì§„ ì •ë¹„ì†Œë“¤ì„ í¬í•¨í•´ì„œ ëª¨ë‘ ì¼ê´„ ì—…ë°ì´íŠ¸
            if (hasCoordinateFields) {
                // ëª¨ë“  ì •ë¹„ì†Œë¥¼ ë‹¤ì‹œ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì¢Œí‘œ ë¬´ì‹œ)
                List<Id> shopsToUpdate = new List<Id>();
                for (Repair_Shop__c shop : repairShops) {
                    if (String.isNotBlank(shop.Address__c)) {
                        shopsToUpdate.add(shop.Id);
                    }
                }
                
                if (!shopsToUpdate.isEmpty()) {
                    System.debug('ğŸ”„ ëª¨ë“  ì •ë¹„ì†Œ ì¢Œí‘œ ì¬ìƒì„± ì‹œì‘ - ëŒ€ìƒ: ' + shopsToUpdate.size() + 'ê°œ');
                    updateMissingCoordinatesInBackground(shopsToUpdate);
                }
            }
            
        } catch(Exception e) {
            System.debug('Error getting repair shops: ' + e.getMessage());
        }
        
        return repairShops;
    }
    
    // ì¢Œí‘œê°€ ì—†ëŠ” ì •ë¹„ì†Œë“¤ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì¼ê´„ ì—…ë°ì´íŠ¸
    @future(callout=true)
    public static void updateMissingCoordinatesInBackground(List<Id> shopIds) {
        List<Repair_Shop__c> shopsToUpdate = new List<Repair_Shop__c>();
        
        System.debug('ğŸ”„ ë°±ê·¸ë¼ìš´ë“œ ì¢Œí‘œ ì—…ë°ì´íŠ¸ ì‹œì‘ - ëŒ€ìƒ ì •ë¹„ì†Œ ìˆ˜: ' + shopIds.size());
        
        // IDë¡œ ì •ë¹„ì†Œ ì •ë³´ ë‹¤ì‹œ ì¡°íšŒ
        List<Repair_Shop__c> shops = [
            SELECT Id, Name, Address__c, Latitude__c, Longitude__c
            FROM Repair_Shop__c 
            WHERE Id IN :shopIds
            LIMIT 3  // API í˜¸ì¶œ ì œí•œì„ ìœ„í•´ í•œ ë²ˆì— 3ê°œê¹Œì§€ë§Œ
        ];
        
        for (Repair_Shop__c shop : shops) {
            // ì£¼ì†Œê°€ ìˆëŠ” ì •ë¹„ì†Œë§Œ ì²˜ë¦¬
            if (String.isBlank(shop.Address__c)) {
                System.debug('âš ï¸ ' + shop.Name + ' - ì£¼ì†Œ ì •ë³´ê°€ ì—†ì–´ ê±´ë„ˆëœ€');
                continue;
            }
            
            // ì‹¤ì œ ì €ì¥ëœ ì£¼ì†Œ ë°ì´í„° í™•ì¸
            System.debug('ğŸ¢ ì •ë¹„ì†Œ: ' + shop.Name + ' | ì €ì¥ëœ ì£¼ì†Œ: "' + shop.Address__c + '"');
            
            // ì •ë¹„ì†Œë³„ êµ¬ì²´ì ì¸ ì£¼ì†Œ ì‚¬ìš© (ì„œì´ˆêµ¬ ì •ë¹„ì†Œë“¤ êµ¬ë¶„ì„ ìœ„í•´)
            String specificAddress = getSpecificAddress(shop.Name, shop.Address__c);
            
            try {
                Map<String, Decimal> coordinates = GoogleMapsController.getCoordinatesFromAddress(specificAddress);
                
                if (coordinates != null && coordinates.containsKey('latitude') && coordinates.containsKey('longitude')) {
                    Repair_Shop__c shopToUpdate = new Repair_Shop__c(
                        Id = shop.Id,
                        Latitude__c = coordinates.get('latitude'),
                        Longitude__c = coordinates.get('longitude')
                    );
                    shopsToUpdate.add(shopToUpdate);
                    
                    System.debug('âœ… ' + shop.Name + ' ìƒˆë¡œìš´ ì¢Œí‘œ ì¤€ë¹„ ì™„ë£Œ: Lat=' + coordinates.get('latitude') + ', Lng=' + coordinates.get('longitude'));
                } else {
                    System.debug('âŒ ' + shop.Name + ' ì¢Œí‘œ ì¡°íšŒ ì‹¤íŒ¨ - ì£¼ì†Œ: ' + specificAddress);
                }
            } catch (Exception e) {
                System.debug('âŒ ' + shop.Name + ' ì¢Œí‘œ ìƒì„± ì‹¤íŒ¨: ' + e.getMessage());
            }
        }
        
        // ì¼ê´„ ì—…ë°ì´íŠ¸ ì‹¤í–‰
        if (!shopsToUpdate.isEmpty()) {
            try {
                update shopsToUpdate;
                System.debug('ğŸ¯ ' + shopsToUpdate.size() + 'ê°œ ì •ë¹„ì†Œ ì¢Œí‘œ ì¼ê´„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            } catch (DmlException e) {
                System.debug('âŒ ì¼ê´„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + e.getMessage());
                for (Integer i = 0; i < e.getNumDml(); i++) {
                    System.debug('âŒ DML Error ' + i + ': ' + e.getDmlMessage(i));
                }
            }
        } else {
            System.debug('âš ï¸ ì—…ë°ì´íŠ¸í•  ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
    }
    
    // ì •ë¹„ì†Œë³„ êµ¬ì²´ì  ì£¼ì†Œ ë°˜í™˜ (ì„œì´ˆêµ¬ ì •ë¹„ì†Œë“¤ êµ¬ë¶„ìš©)
    private static String getSpecificAddress(String shopName, String originalAddress) {
        // ì„œì´ˆêµ¬ ì •ë¹„ì†Œë“¤ì— ëŒ€í•´ êµ¬ì²´ì ì¸ ì£¼ì†Œ ë§¤í•‘
        Map<String, String> specificAddresses = new Map<String, String>{
            'CRMì˜¤í† í ì„œì´ˆë‚¨ë¶€ì ' => 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ë‚¨ë¶€ìˆœí™˜ë¡œ 2085',
            'CRMì˜¤í† í ë°©ë°°ì ' => 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ë°©ë°°ë¡œ 173',
            'CRMì˜¤í† í ì„œì´ˆì ' => 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ì„œì´ˆëŒ€ë¡œ 398',
            'CRMì˜¤í† í ì„œì´ˆì¤‘ì•™ì ' => 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ íš¨ë ¹ë¡œ 265',
            'CRMì˜¤í† í ë°˜í¬ì ' => 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ë°˜í¬ëŒ€ë¡œ 145'
        };
        
        // ë§¤í•‘ëœ ì£¼ì†Œê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì›ë˜ ì£¼ì†Œ ì‚¬ìš©
        if (specificAddresses.containsKey(shopName)) {
            System.debug('ğŸ¯ ' + shopName + 'ì— ëŒ€í•œ êµ¬ì²´ì  ì£¼ì†Œ ì‚¬ìš©: ' + specificAddresses.get(shopName));
            return specificAddresses.get(shopName);
        }
        
        System.debug('ğŸ“ ' + shopName + 'ì— ëŒ€í•œ ì¼ë°˜ ì£¼ì†Œ ì‚¬ìš©: ' + originalAddress);
        return originalAddress;
    }
}